
@Html.Partial("_CustomFieldEditorDialog", new CustomFieldEditorModel())

<div style="display: none;">
    <script type="text/template" id="custom_field_row_template">
        <tr data-bind="jqData:$data">
            <td class="nocheckbox draggable">
                <div>@Html.IconImage("drag")</div>
                <!--ko if:!!$parent.nameFmt()-->
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'Id')}, value:Id" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'Name')}, value:Name" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'DataType')}, value:DataType" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'Label')}, value:Label" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'Tooltip')}, value:Tooltip" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'ControlType')}, value:ControlType" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'DefaultValue')}, value:DefaultValue" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'IsValueLocalizable')}, value:(IsValueLocalizable()+'')" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtName($index,'SelectionItems')}, value:SelectionItems" />
                <!--ko foreach:ValidationRules-->
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtRuleName($parentContext.$index,$index,'Id')}, value:Id" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtRuleName($parentContext.$index,$index,'ValidatorName')}, value:ValidatorName" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtRuleName($parentContext.$index,$index,'ValidatorData')}, value:ValidatorData" />
                <input type="hidden" name="{ko}" data-bind="attr:{name:$root.fmtRuleName($parentContext.$index,$index,'ErrorMessage')}, value:ErrorMessage" />
                <!--/ko-->
                <!--/ko-->
            </td>
            <td><a class="action" data-bind="text:Name, click:$root.editField"></a></td>
            <td data-bind="text:((Label()==''||Label()==null)?'-':Label)"></td>
            <td data-bind="text:ControlType"></td>
            <td class="action"><a class="action" data-bind="click:$root.removeField">@Html.IconImage("minus-small")</a></td>
        </tr>
    </script>
    <script type="text/javascript">
        var isEditingPredefinedFields = @(ViewBag.IsEditingPredefinedFields == null ? "false" : ViewBag.IsEditingPredefinedFields.ToString().ToLower());
        (function ($, ko) {
            // override
            $.validator.setDefaults({ ignore: 'input[type="hidden"]' });

            // tools
            var utilities = {
                cloneObject: function (obj) {
                    return ko.mapping.fromJS(ko.toJS(obj));
                },
                copyValue: function (fromObs, toObs) {
                    $.each(fromObs, function (key, val) {
                        if ($.type(val) === 'function' && toObs[key]) {
                            toObs[key](val());
                        } else if (val instanceof keyValuePairArray) {
                            toObs[key].update(val.json());
                        }
                    });
                },
                dialogElem: function () {
                    return $('#custom_field_editor_dialog');
                },
                fieldEditorTabs: function () {
                    return this.dialogElem().find('#custom_field_editor_tabs');
                },
                fieldEditorForm: function () {
                    return $('#custom_field_editor_form');
                },
                showDialog: function (ref, field, exist) {
                    customFieldModel.initialize(ref, field, exist);
                    this.updateFieldEditorValidation();
                    return this.dialogElem().dialog({
                        title: field.Name() || '',
                        autoOpen: false,
                        width: 780,
                        modal: true,
                        draggable: false,
                        resizable: false,
                        create: function () {
                            $(document).dialogScroll();
                        }
                    }).dialog('open');
                },
                updateFieldEditorValidation: function () {
                    this.fieldEditorForm().find('.input-validation-error').removeClass('input-validation-error').addClass('valid');
                    this.fieldEditorForm().find('.field-validation-error').removeClass('field-validation-error').addClass('field-validation-valid').empty();
                    this.fieldEditorForm().removeData('validator').removeData('unobtrusiveValidation');
                    $.validator.unobtrusive.parse(this.fieldEditorForm());
                }
            };

            var keyValuePairArray = function (jsonData, dict) {
                var self = this;
                this.items = ko.observableArray();
                this.items.subscribe(function () {
                    utilities.updateFieldEditorValidation();
                });
                this.add = function () {
                    self.items.push(ko.mapping.fromJS({ Key: '', Value: '' }));
                };
                this.remove = function (item) {
                    self.items.remove(item);
                };
                this.update = function (json) {
                    var arr = [];
                    if (dict) {
                        var obj = $.parseJSON(json || '{}');
                        $.each(obj, function (key, val) {
                            arr.push(ko.mapping.fromJS({ Key: key, Value: val }));
                        });
                    } else {
                        arr = ko.mapping.fromJS($.parseJSON(json || '[]'))();
                    }
                    self.items(arr);
                };
                this.json = function () {
                    if (self.items().length === 0) { return ''; }
                    var arr = [], obj = {}, currents = ko.mapping.toJS(self.items);
                    $.each(currents, function () {
                        if (dict) {
                            if (this.Key) { obj[this.Key] = this.Value; }
                        } else {
                            arr.push(this);
                        }
                    });
                    return $.toJSON(dict ? obj : arr);
                };
                this.update(jsonData);
            };

            //
            var emptyCustomField = $.parseJSON('@Html.Raw(new CustomFieldEditorModel().ToJson(PropertyNaming.Default))');
            var emptyValidationRules = {};
            emptyValidationRules['@ValidatorType.Required'] = $.parseJSON('@Html.Raw(new FieldValidationRuleEditorModel() { ValidatorName = ValidationType.Required.ToString() }.ToJson(PropertyNaming.Default))');
            emptyValidationRules['@ValidatorType.Required'].ValidatorData = '@Html.Raw(new { }.ToJson(PropertyNaming.Default))';
            emptyValidationRules['@ValidatorType.Unique'] = $.parseJSON('@Html.Raw(new FieldValidationRuleEditorModel() { ValidatorName = ValidationType.Unique.ToString() }.ToJson(PropertyNaming.Default))');
            emptyValidationRules['@ValidatorType.Unique'].ValidatorData = '@Html.Raw(new { }.ToJson(PropertyNaming.Default))';
            emptyValidationRules['@ValidatorType.StringLength'] = $.parseJSON('@Html.Raw(new FieldValidationRuleEditorModel() { ValidatorName = ValidationType.StringLength.ToString() }.ToJson(PropertyNaming.Default))');
            emptyValidationRules['@ValidatorType.StringLength'].ValidatorData = '@Html.Raw(new { Min = 0, Max = 0 }.ToJson(PropertyNaming.Default))';
            emptyValidationRules['@ValidatorType.Range'] = $.parseJSON('@Html.Raw(new FieldValidationRuleEditorModel() { ValidatorName = ValidationType.Range.ToString() }.ToJson(PropertyNaming.Default))');
            emptyValidationRules['@ValidatorType.Range'].ValidatorData = '@Html.Raw(new { Start = 0, End = 0 }.ToJson(PropertyNaming.Default))';
            emptyValidationRules['@ValidatorType.Regex'] = $.parseJSON('@Html.Raw(new FieldValidationRuleEditorModel() { ValidatorName = ValidationType.Regex.ToString() }.ToJson(PropertyNaming.Default))');
            emptyValidationRules['@ValidatorType.Regex'].ValidatorData = '@Html.Raw(new { Pattern = string.Empty }.ToJson(PropertyNaming.Default))';

            //
            var fieldsGridModel = function (set) {
                var self = this;
                this.container = null;
                this.nameFmt = ko.observable(set.nameFmt);
                this.fields = ko.mapping.fromJS(set.data);
                this.systemFields = ko.mapping.fromJS($.parseJSON('@Html.Raw(ViewData["SystemFields"].ToJson(PropertyNaming.Default))'));
                this.fields.subscribe(function () {
                    $.each(self.fields(), function (i) {
                        this.Sequence(i + 1);
                    });
                });
                //
                this.addField = function () {
                    var count = self.fields().length;
                    var dialog = window.CustomFieldEditorDialog.instance();
                    dialog.onSubmitted = function (model) {
                        self.fields.push(ko.mapping.fromJS(model));
                    };
                    dialog.open({
                        model: {
                            Sequence: count + 1,
                            IsPredefined: isEditingPredefinedFields
                        }
                    });
                };
                //
                this.editField = function (field) {
                    var dialog = window.CustomFieldEditorDialog.instance();
                    dialog.onSubmitted = function (model) {
                        ko.mapping.fromJS(model, {}, field);
                    };
                    dialog.open({
                        model: ko.mapping.toJS(field)
                    });
                };
                //
                this.insertField = function (item) {
                    self.fields.push(utilities.cloneObject(item));
                };
                //
                this.removeField = function (item) {
                    if (confirm('@("Are you sure you want to delete this item?".Localize())')) {
                        self.fields.remove(item);
                        window.leaveConfirm.stop();
                        return true;
                    }
                };
                this.addSystemField = function () {
                    var dialog = window.AddPredefinedFieldsDialog.instance();
                    if (!dialog.onSubmitted) {
                        dialog.onSubmitted = function (ids) {
                            _.each(ids, function (id) {
                                var field = _.find(self.systemFields(), function (f) {
                                    return f.Id() == id;
                                });
                                if (field) {
                                    self.insertField(field);
                                }
                            });
                        }
                    }

                    dialog.open();
                };

                //
                this.fmtName = function (index, name) {
                    return $.format(self.nameFmt(), index(), name);
                };
                this.fmtRuleName = function (parentIndex, index, name) {
                    var fmt = self.fmtName(parentIndex, 'ValidationRules[{0}].{1}');
                    return $.format(fmt, index(), name);
                };
            };

            // custom validator
            //$.validator.addMethod('uniquecolumn', function (value) {
            //    var fields = customFieldModel.currentRef().fields();
            //    return !ko.utils.arrayFirst(fields, function (item) {
            //        return item.Name() && item.Name().toLowerCase() === value.toLowerCase();
            //    });
            //});
            //$.validator.unobtrusive.adapters.addBool('uniquecolumn');

            // custom binding
            ko.bindingHandlers.jqData = {
                update: function (element, valueAccessor, allValueAccessor, viewModel) {
                    var data = valueAccessor() || viewModel;
                    $(element).data('attachedData', data);
                }
            };

            // export function
            $.fn.customFields = function (set) {
                return this.each(function () {
                    // ko
                    var model = new fieldsGridModel(set);
                    ko.applyBindings(model, this);
                    model.container = this;
                    $(this).data('fieldsGridModel', model);
                    // jq
                    $(this).find('table tbody').sortable({
                        helper: function (ev, ui) {
                            ui.children().each(function () {
                                $(this).width($(this).width());
                            });
                            return ui;
                        },
                        distance: 5,
                        start: function (event, ui) {
                            ui.placeholder.html('<td colspan="100"></td>');
                        },
                        stop: function (ev, ui) {
                            var newSequenceFields = []
                            ui.item.parent().children().each(function () {
                                newSequenceFields.push($(this).data('attachedData'));
                            });
                            var model = ui.item.parents('table').data('attachedData')
                            model.fields([]); model.fields(newSequenceFields);
                            window.leaveConfirm.stop();
                        }
                    });
                });
            };
            
        }(jQuery, ko));
    </script>
</div>
