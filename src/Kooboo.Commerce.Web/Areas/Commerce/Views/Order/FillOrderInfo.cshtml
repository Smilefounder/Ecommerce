@using Kooboo.Commerce.Web.Mvc;
@using Kooboo.Commerce.Orders;
@using Kooboo.Commerce.Payments;
@model Kooboo.Commerce.Orders.Order
@{
    ViewBag.Title = "Create an Order".Localize();
    Layout = "~/Views/Shared/Blank.cshtml";
}

@section Panel{
    <ul class="header-panel">
    <li>
        <a href="@ViewBag.Return">
            @Html.IconImage("cancel") @("Previous".Localize())
        </a>
    </li>
    <li>
        <a href="javascript:;" onclick="window.leaveConfirm.pass(); $('form').submit();">
            @Html.IconImage("save") @("Save Order".Localize())
        </a>
    </li>
    <li>
        <a href="/Commerce/Order?commerceName=@Request.QueryString["commercename"]">
            @Html.IconImage("cancel") @("Cancel".Localize())
        </a>
    </li>
</ul>
}


<div class="block">
    <div class="wizard">
        <div class="container">
            <span>@("Select a Customer".Localize())</span>
            <span>@("Select Products".Localize())</span>
            <span class="active">@("Fill Order Info".Localize())<b></b></span>
        </div>
    </div>
    @if (TempData["Message"] != null)
    {
        <div class="message">
            @TempData["Message"]
        </div>
    }
    @using (Html.BeginForm("Save", "Order", RouteValues.From(Request.QueryString)))
    {
        <div class="order-form clearfix">
			<div class="columns">
				<div class="span6">
					<div class="common-form">
					<fieldset>
						<legend>
							@("Order info".Localize())
						</legend>
						<table>
							<tbody>
								<tr>
									<th>@("Order Id".Localize())</th>
									<td>
										<span>@Model.Id</span>
									</td>
								</tr>
								<tr>
									<th>@("Customer".Localize())</th>
									<td>
										<span>@Model.Customer.FullName</span>
									</td>
								</tr>
								<tr>
									<th>@("Shopping Cart".Localize())</th>
									<td>
										@if(Model.ShoppingCart == null)
										{
											<span>No Shopping Cart</span>
										}
										else
										{
											<a href="/Commerce/ShoppingCart/@(Model.ShoppingCart.Id)?commerceName=@Request.QueryString["commerceName"]">@(Model.ShoppingCart.Id)</a>
										}
									</td>
								</tr>
								<tr>
									<th>@("Coupon".Localize())</th>
									<td>
										@Html.TextBoxFor(i => i.Coupon, new { @class = "medium" })
									</td>
								</tr>
								<tr>
									<th>@("Order Status".Localize())</th>
									<td>
										@Html.DropDownListFor(i => i.OrderStatus, EnumUtil.ToSelectList<OrderStatus>(), new { @class = "medium" })
									</td>
								</tr>
								<tr>
									<th>@("Payment Status".Localize())</th>
									<td>
										@Html.DropDownListFor(i => i.PaymentStatus, EnumUtil.ToSelectList<PaymentStatus>(), new { @class = "medium" })
									</td>
								</tr>
								<tr>
									<th>@("Created At".Localize())</th>
									<td>
										<span>@Model.CreatedAtUtc.ToShortDateString()</span>
									</td>
								</tr>
							</tbody>
						</table>
					</fieldset>
				</div>
				</div>
				<div class="span6">
					<div class="common-form">
                <fieldset>
                    <legend>
                        <span>
                            @("Order totals".Localize())
                        </span>
                    </legend>
                    <table>
                        <tbody>
                            <tr>
                                <th>
                                    @("Subtotal".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.SubTotal, new { @class = "medium", onchange = "Calculate();" })
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Discount".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.Discount, new { @class = "medium", onchange = "Calculate();" })
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Total Tax".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.TotalTax, new { @class = "medium", onchange = "Calculate();" })
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Total Weight".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.TotalWeight, new { @class = "medium" })
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Shipping Cost".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.ShippingCost, new { @class = "medium", onchange="Calculate();" })
                                </td>
                            </tr>
                            <tr>
                                <th>@("Payment Method".Localize())</th>
                                <td>
                                    <select id="PaymentMethodId" name="PaymentMethodId" onchange="Calculate();" class="medium">
                                        <option value=""></option>
                                        @foreach (var pm in ViewBag.PaymentMethods)
                                        {
                                            <option value="@pm.Id" data-method="@pm.AdditionalFeeChargeMode" data-amount="@pm.AdditionalFeeAmount" data-percent="@pm.AdditionalFeePercent" @(pm.Id == (Model.PaymentMethodId.HasValue ? Model.PaymentMethodId.Value : 0) ? "selected='selected'" : "")>@pm.DisplayName</option>
                                        }
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Payment Method Cost".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.PaymentMethodCost, new { @class = "medium", onchange = "Calculate();" })
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    @("Total".Localize())
                                </th>
                                <td>
                                    @Html.TextBoxFor(i => i.Total, new { @class = "medium" })
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </fieldset>
            </div>
				</div>
			</div>
            
        </div>
        <div class="order-form clearfix">
			<div class="columns">
				<div class="span6">
					<div class="common-form">
                <fieldset>
                    <legend>
                        @("Shipping address".Localize())
                    </legend>
                    @Html.Partial("_Address", Model.ShippingAddress, Kooboo.Commerce.Web.Mvc.FormHelper.AppendOrReplace(ViewData, "ControlId", "ShippingAddress"))
                </fieldset>
            </div>
				</div>
				<div class="span6">
					<div class="common-form">
                <fieldset>
                    <legend>
                        @("Billing address".Localize())
                    </legend>
                    @Html.Partial("_Address", Model.BillingAddress, Kooboo.Commerce.Web.Mvc.FormHelper.AppendOrReplace(ViewData, "ControlId", "BillingAddress"))
                </fieldset>
            </div>
				</div>
			</div>
        </div>
        <div class="common-form order-form">
            <fieldset>
                <legend>
                    @("Order remark".Localize())
                </legend>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                @Html.TextAreaFor(i => i.Remark, new { style = "height: 96px; width: 100%;" })
                            </td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>
    }
</div>
<script type="text/javascript">
    function Calculate() {
        var op = $('#PaymentMethodId').find('option:selected');
        var chargeMethod = op.attr('data-method') || 'ByAmount';
        var amount = parseFloat(op.attr('data-amount')) || 0;
        var percent = parseFloat(op.attr('data-percent')) || 0;
        var subtotal = parseFloat($("#SubTotal").val()) || 0;
        var discount = parseFloat($("#Discount").val()) || 0;
        var tax = parseFloat($("#TotalTax").val()) || 0;
        var shippingCost = parseFloat($("#ShippingCost").val()) || 0;
        var cost = chargeMethod == 'ByAmount' ? amount : (percent > 0 ? subtotal * percent : 0); // 0: charge by amount 1: charge by percent
        if (cost <= 0)
            cost = parseFloat($('#PaymentMethodCost').val()) || 0;
        var total = subtotal - discount + tax + shippingCost + cost;
        $('#PaymentMethodCost').val(cost);
        $('#Total').val(total);
    }
</script>
