@using Kooboo.Commerce.Web.Framework.UI.Form
@{
    var productType = (ProductType)ViewBag.ProductType;
    var controls = FormControls.Controls().ToList();
}

<div class="simple-table">
    <input type="hidden" name="FieldType" value="VariantField" />
    <div class="toolbar">
        <a class="button" href="javascript:;" data-bind="click: $root.AddPrice">Add</a>
        @if (productType.VariantFieldDefinitions.Count > 0)
        {
            <a href="#" class="button" data-action="set-variant-values">@("Bulk add".Localize())</a>
        }
        <span data-bind="visible: $root.AnyPriceSelected">
            <a href="#" class="button" data-action="bulk-change-price">@("Change prices".Localize())</a>
            <a href="#" class="button" data-bind="click: $root.DeleteSelectedPrices">@("Delete".Localize())</a>
        </span>
    </div>
    <table class="variants-table">
        <thead>
            <tr>
                <th class="checkbox mutiple">
                    <div data-toggle="dropdown">
                        <input type="checkbox" class="select-all-prices">
                        @Html.IconImage("caret-down-black")
                        <ul class="dropdown hide">
                            <!-- ko if: $root.DistinctVariantValuesByFields().length > 0 -->
                                <li><a href="#" data-bind="click: $root.SelectAllPrices">@("All".Localize())</a></li>
                                <!-- ko foreach: $root.DistinctVariantValuesByFields -->
                                <!-- ko foreach: Values -->
                                <li>
                                    <a data-bind="text: $data, click: $root.SelectPricesByFieldValue.bind($data, $parent.Name)"></a>
                                </li>
                                <!-- /ko -->
                                <!-- /ko -->
                                <li><a href="#" data-bind="click: $root.ClearPriceSelection">@("None".Localize())</a></li>
                            <!-- /ko -->
                            <!-- ko if: $root.DistinctVariantValuesByFields().length === 0 -->
                            <li>
                                <a href="javascript:void(0);">@("No available variant values".Localize())</a>
                            </li>
                            <!-- /ko -->
                        </ul>
                    </div>
                </th>
                <th>@("Sku".Localize())</th>
                @foreach (var field in productType.VariantFieldDefinitions)
                {
                    <th>@field.Label</th>
                }
                <th class="mini">@("Price".Localize())</th>
                <th class="action"></th>
                <th class="action"></th>
            </tr>
        </thead>
        <tbody data-bind="if: $root.data().Variants().length === 0">
            <tr class="empty">
                <td colspan="100">
                    @("Empty".Localize())
                </td>
            </tr>
        </tbody>
        <tbody data-bind="foreach: { data: $root.data().Variants, afterRender: $root.InitVariantFieldControls }">
            <tr data-bind="visible: !$root.IsEditingPrice($data), css: { active: Selected }">
                <td class="checkbox">
                    <input type="checkbox" class="select" data-bind="checked: Selected" />
                </td>
                <td data-bind="text:Sku"></td>
                @foreach (var field in productType.VariantFieldDefinitions)
                {
                    <td data-bind="text: $root.GetVariantFieldText($data, '@field.Name')"></td>
                }
                <td class="mini" data-bind="text:Price"></td>
                <td><a data-bind="click: $root.EditingPrice" title="Edit">@Html.IconImage("edit-small")</a></td>
                <td><a data-bind="click: $root.DeletePrice" title="Delete">@Html.IconImage("minus-small")</a></td>
            </tr>
            <tr data-bind="visible: $root.IsEditingPrice($data)">
                <td>
                    <input type="checkbox" class="select" data-bind="checked: Selected" />
                </td>
                <td><input type="text" data-bind="value:Sku"></td>
                @foreach (var field in productType.VariantFieldDefinitions)
                {
                    var control = controls.FirstOrDefault(c => c.Name == field.ControlType) ?? controls.First();

                    <td>
                        @control.Render(field, null, new
                                       {
                                           data_field_type = "VariantField",
                                           data_bind = control.ValueBindingName + ": $root.GetVariantFieldValue($data, '" + field.Name + "')"
                                       }, ViewContext)
                    </td>
                }
                <td class="mini"><input type="text" data-bind="value:Price" class="mini"></td>
                <td><a data-bind="click: $root.CommitPriceEditing" title="Save">@Html.IconImage("save-small")</a></td>
                <td><a data-bind="click: $root.DeletePrice" title="Cancel">@Html.IconImage("minus-small")</a></td>
            </tr>
        </tbody>
    </table>
</div>
